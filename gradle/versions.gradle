ant.condition(property: "os", value: "windows") { os(family: "windows") }
ant.condition(property: "os", value: "unix") { os(family: "unix") }

def out = new ByteArrayOutputStream()
exec {
  def releaseTagPattern = "v*.*"
  def describeCmd = ["git", "describe", "--tags", "--match", releaseTagPattern]
  switch (ant.properties.os) {
    case "windows":
      commandLine(["cmd", "/c"] + describeCmd)
      break
    case "unix":
      commandLine(describeCmd)
      break
    default:
      logger.error("unknown os")
      throw new RuntimeException("unknown os.(" + ant.properties + ")")
  }
  standardOutput = out
}

def (_, tag, count, gitHash) = (out.toString().trim() =~ /^v([^-]+)-(\d+)-(g[0-9a-f]+)$/)[0]

project.ext.versionTag = tag
project.ext.commitCount = count
project.ext.commitHash = gitHash
